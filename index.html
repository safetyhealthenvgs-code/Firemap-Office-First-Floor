<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>แผนผังถังดับเพลิง</title>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    h2 {
      text-align: center;
    }

    .filter {
      text-align: center;
      margin-bottom: 12px;
    }

    .map-container {
      position: relative;
      width: 100%;
      max-width: 873px;
      aspect-ratio: 873 / 600;
      background-image: url('https://github.com/safetyhealthenvgs-code/Firemap-Office-First-Floor/blob/main/Lay%20out%20Office%20fist%20Floor.jpg?raw=true');
      background-size: contain;
      background-position: top left;
      background-repeat: no-repeat;
      border: 1px solid #ccc;
      margin: auto;
    }

    .map-container::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0,0,0,0.05) 1px, transparent 1px);
      background-size: 10% 10%;
      pointer-events: none;
    }

    .marker {
      position: absolute;
      width: 12px;
      height: 12px;
      background-color: red;
      border: 2px solid white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
      box-shadow: 0 0 3px rgba(0,0,0,0.5);
    }

    .marker:hover::after {
      content: attr(data-info);
      position: absolute;
      top: -55px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: normal;
      z-index: 10;
      min-width: 160px;
      text-align: left;
    }
  </style>
</head>

<body>

  <h2>แผนผังถังดับเพลิง</h2>

  <div class="filter">
    <label>เลือกเดือน: </label>
    <select id="monthFilter"></select>
  </div>

  <div class="map-container" id="map"></div>

  <script>
    /* ================= CONFIG ================= */
    const SHEET_ID = "18YbWGcRIHhxv40v_7NTXQUNL3mV9jnNQrjfcUOvQEQs";
    const SHEET_NAME = "Zone Office First Floor";
    const DATE_COL = 1; // คอลัมน์วันที่ (เริ่มนับจาก 0)
    const INSPECTOR_COL = 2;
    const NUMBER_COL = 3;
    const XY_COL = 13;

    const TH_MONTHS = [
      "ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.",
      "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.",
      "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."
    ];
    /* ========================================== */

    const jsonUrl =
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

    let allRows = [];

    fetch(jsonUrl)
      .then(res => res.text())
      .then(text => {
        const json = JSON.parse(text.substring(47).slice(0, -2));
        allRows = json.table.rows;
        buildMonthSelector();
      })
      .catch(err => console.error("โหลดข้อมูลไม่สำเร็จ", err));

    function buildMonthSelector() {
      const monthMap = new Map();

      allRows.forEach(row => {
        const cell = row.c[DATE_COL];
        if (!cell || !cell.v) return;

        const d = new Date(cell.v);
        if (isNaN(d)) return;

        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
        const label = `${TH_MONTHS[d.getMonth()]} ${d.getFullYear() + 543}`;

        monthMap.set(key, label);
      });

      const select = document.getElementById("monthFilter");
      select.innerHTML = "";

      [...monthMap.entries()]
        .sort((a, b) => b[0].localeCompare(a[0]))
        .forEach(([key, label]) => {
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = label;
          select.appendChild(opt);
        });

      if (select.options.length > 0) {
        renderMap(select.value);
      }

      select.addEventListener("change", () => renderMap(select.value));
    }

    function renderMap(selectedMonth) {
      const map = document.getElementById("map");
      map.innerHTML = "";

      allRows.forEach(row => {
        const dateCell = row.c[DATE_COL];
        if (!dateCell || !dateCell.v) return;

        const d = new Date(dateCell.v);
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
        if (key !== selectedMonth) return;

        const xyStr = row.c[XY_COL]?.v || "";
        if (!xyStr.includes(",")) return;

        const [xStr, yStr] = xyStr.split(",");
        const x = parseFloat(xStr);
        const y = parseFloat(yStr);
        if (isNaN(x) || isNaN(y) || x < 0 || x > 100 || y < 0 || y > 100) return;

        const info = `
          วันที่ตรวจ: ${d.toLocaleDateString("th-TH")}<br>
          หมายเลขถัง: ${row.c[NUMBER_COL]?.v || ""}<br>
          ผู้ตรวจ: ${row.c[INSPECTOR_COL]?.v || ""}
        `;

        const marker = document.createElement("div");
        marker.className = "marker";
        marker.style.left = `${x}%`;
        marker.style.top = `${y}%`;
        marker.setAttribute("data-info", info);

        map.appendChild(marker);
      });
    }
  </script>

</body>
</html>





