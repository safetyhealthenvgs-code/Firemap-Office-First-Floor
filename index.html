<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>แผนผังถังดับเพลิง</title>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    h2 {
      text-align: center;
    }

    .filter {
      text-align: center;
      margin-bottom: 10px;
    }

    .map-container {
      position: relative;
      width: 100%;
      max-width: 873px;
      aspect-ratio: 873 / 600;
      background-image: url('https://github.com/safetyhealthenvgs-code/Firemap-Office-First-Floor/blob/main/Lay%20out%20Office%20fist%20Floor.jpg?raw=true');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: top left;
      border: 1px solid #ccc;
      margin: auto;
    }

    .map-container::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0,0,0,0.05) 1px, transparent 1px);
      background-size: 10% 10%;
      pointer-events: none;
    }

    .marker {
      position: absolute;
      width: 12px;
      height: 12px;
      background-color: red;
      border: 2px solid white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
      box-shadow: 0 0 3px rgba(0,0,0,0.5);
    }

    .marker:hover::after {
      content: attr(data-info);
      position: absolute;
      top: -60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: normal;
      z-index: 10;
      min-width: 160px;
      text-align: left;
    }
  </style>
</head>

<body>

<h2>แผนผังถังดับเพลิง</h2>

<div class="filter">
  <label>เลือกเดือน: </label>
  <select id="monthFilter"></select>
</div>

<div class="map-container" id="map"></div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID = "18YbWGcRIHhxv40v_7NTXQUNL3mV9jnNQrjfcUOvQEQs";
const SHEET_NAME = "Zone Office First Floor";

/* จาก Google Sheet ที่คุณส่งมา */
const DATE_COL = 1;        // B: วันที่ตรวจถังดับเพลิง
const INSPECTOR_COL = 2;   // C: ชื่อผู้ตรวจ
const NUMBER_COL = 3;      // D: หมายเลขถัง
const XY_COL = 13;         // N: ตำแหน่งถัง (X,Y)

const TH_MONTHS = [
  "ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.",
  "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.",
  "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."
];
/* ========================================= */

const jsonUrl =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

let allRows = [];

/* ---------- LOAD DATA ---------- */
fetch(jsonUrl)
  .then(res => res.text())
  .then(text => {
    const json = JSON.parse(text.substring(47).slice(0, -2));
    allRows = json.table.rows;
    buildMonthSelector();
  })
  .catch(err => console.error("โหลดข้อมูลไม่สำเร็จ", err));

/* ---------- PARSE DATE (รองรับ พ.ศ.) ---------- */
function parseSheetDate(cell) {
  if (!cell || !cell.v) return null;

  // กรณีเป็น string เช่น 27/9/2568
  if (typeof cell.v === "string") {
    const parts = cell.v.split("/");
    if (parts.length === 3) {
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1;
      let year = parseInt(parts[2], 10);

      if (year > 2400) year -= 543; // พ.ศ. → ค.ศ.

      const d = new Date(year, month, day);
      if (!isNaN(d)) return d;
    }
  }

  // กรณี Google ส่ง Date object มา
  if (cell.v instanceof Date) {
    return cell.v;
  }

  return null;
}

/* ---------- BUILD DROPDOWN ---------- */
function buildMonthSelector() {
  const monthMap = new Map();

  allRows.forEach(row => {
    const d = parseSheetDate(row.c[DATE_COL]);
    if (!d) return;

    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
    const label = `${TH_MONTHS[d.getMonth()]} ${d.getFullYear() + 543}`;

    monthMap.set(key, label);
  });

  const select = document.getElementById("monthFilter");
  select.innerHTML = "";

  if (monthMap.size === 0) {
    const opt = document.createElement("option");
    opt.textContent = "ไม่พบข้อมูลเดือน";
    select.appendChild(opt);
    console.warn("❌ ไม่พบข้อมูลวันที่จาก Google Sheet");
    return;
  }

  [...monthMap.entries()]
    .sort((a, b) => b[0].localeCompare(a[0]))
    .forEach(([key, label]) => {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = label;
      select.appendChild(opt);
    });

  renderMap(select.value);
  select.addEventListener("change", () => renderMap(select.value));
}

/* ---------- RENDER MAP ---------- */
function renderMap(selectedMonth) {
  const map = document.getElementById("map");
  map.innerHTML = "";

  allRows.forEach(row => {
    const d = parseSheetDate(row.c[DATE_COL]);
    if (!d) return;

    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
    if (key !== selectedMonth) return;

    const xyStr = row.c[XY_COL]?.v || "";
    if (!xyStr.includes(",")) return;

    const [xStr, yStr] = xyStr.split(",");
    const x = parseFloat(xStr);
    const y = parseFloat(yStr);
    if (isNaN(x) || isNaN(y)) return;

    const info = `
      วันที่ตรวจ: ${d.toLocaleDateString("th-TH")}<br>
      หมายเลขถัง: ${row.c[NUMBER_COL]?.v || ""}<br>
      ผู้ตรวจ: ${row.c[INSPECTOR_COL]?.v || ""}
    `;

    const marker = document.createElement("div");
    marker.className = "marker";
    marker.style.left = `${x}%`;
    marker.style.top = `${y}%`;
    marker.setAttribute("data-info", info);

    map.appendChild(marker);
  });
}
</script>

</body>
</html>


