<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>แผนผังถังดับเพลิง</title>

<style>
body{font-family:sans-serif;padding:20px}
h2{text-align:center}
.filter{text-align:center;margin-bottom:10px}

.map-container{
  position:relative;
  width:100%;
  max-width:873px;
  aspect-ratio:873/600;
  background:url('https://github.com/safetyhealthenvgs-code/Firemap-Office-First-Floor/blob/main/Lay%20out%20Office%20fist%20Floor.jpg?raw=true') no-repeat top left;
  background-size:contain;
  border:1px solid #ccc;
  margin:auto;
}

.marker{
  position:absolute;
  width:12px;height:12px;
  background:red;
  border:2px solid #fff;
  border-radius:50%;
  transform:translate(-50%,-50%);
}

.marker:hover::after{
  content:attr(data-info);
  position:absolute;
  top:-60px;left:50%;
  transform:translateX(-50%);
  background:#000c;
  color:#fff;
  padding:6px 8px;
  font-size:12px;
  border-radius:4px;
  white-space:pre;
}
</style>
</head>

<body>

<h2>แผนผังถังดับเพลิง</h2>

<div class="filter">
  เลือกเดือน:
  <select id="monthFilter"></select>
</div>

<div class="map-container" id="map"></div>

<script>
/* =============== CONFIG =============== */
const SHEET_ID="18YbWGcRIHhxv40v_7NTXQUNL3mV9jnNQrjfcUOvQEQs";
const SHEET_NAME="Zone Office First Floor";

const DATE_COL=1;      // B วันที่ตรวจ
const INSPECTOR_COL=2; // C
const NUMBER_COL=3;    // D
const XY_COL=13;       // N (x,y)
/* ==================================== */

const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
let rows=[];

/* ---------- LOAD DATA ---------- */
fetch(url)
.then(r=>r.text())
.then(t=>{
  const json=JSON.parse(t.substring(47).slice(0,-2));
  rows=json.table.rows;
  buildDropdown();
})
.catch(e=>console.error(e));

/* ---------- PARSE DATE (27/9/2568) ---------- */
function parseThaiDate(cell){
  if(!cell || !cell.v) return null;

  if(typeof cell.v === "string"){
    const p = cell.v.trim().split("/");
    if(p.length!==3) return null;

    const day=parseInt(p[0],10);
    const month=parseInt(p[1],10); // 1–12
    const year=parseInt(p[2],10);  // 2568

    if(isNaN(day)||isNaN(month)||isNaN(year)) return null;
    return {day,month,year};
  }
  return null;
}

/* ---------- BUILD DROPDOWN (9/2568) ---------- */
function buildDropdown(){
  const map=new Map();

  rows.forEach(r=>{
    const d=parseThaiDate(r.c[DATE_COL]);
    if(!d) return;

    const key=`${d.month}/${d.year}`; // ✅ ตรง Sheet
    map.set(key,key);
  });

  const sel=document.getElementById("monthFilter");
  sel.innerHTML="";

  if(map.size===0){
    sel.innerHTML="<option>ไม่พบข้อมูลเดือน</option>";
    return;
  }

  [...map.keys()]
    .sort((a,b)=>{
      const [ma,ya]=a.split("/").map(Number);
      const [mb,yb]=b.split("/").map(Number);
      return yb-ya || mb-ma;
    })
    .forEach(v=>{
      const o=document.createElement("option");
      o.value=v;
      o.textContent=v;
      sel.appendChild(o);
    });

  render(sel.value);
  sel.onchange=()=>render(sel.value);
}

/* ---------- RENDER MAP ---------- */
function render(selected){
  const mapEl=document.getElementById("map");
  mapEl.innerHTML="";

  rows.forEach(r=>{
    const d=parseThaiDate(r.c[DATE_COL]);
    if(!d) return;

    if(`${d.month}/${d.year}`!==selected) return;

    const xy=r.c[XY_COL]?.v;
    if(!xy||!xy.includes(",")) return;

    const [x,y]=xy.split(",").map(Number);
    if(isNaN(x)||isNaN(y)) return;

    const info=
`วันที่ตรวจ: ${d.day}/${d.month}/${d.year}
หมายเลขถัง: ${r.c[NUMBER_COL]?.v||""}
ผู้ตรวจ: ${r.c[INSPECTOR_COL]?.v||""}`;

    const m=document.createElement("div");
    m.className="marker";
    m.style.left=`${x}%`;
    m.style.top=`${y}%`;
    m.setAttribute("data-info",info);
    mapEl.appendChild(m);
  });
}
</script>

</body>
</html>



