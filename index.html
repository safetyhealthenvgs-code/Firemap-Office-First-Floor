<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡∏ñ‡∏±‡∏á‡∏î‡∏±‡∏ö‡πÄ‡∏û‡∏•‡∏¥‡∏á</title>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    h2 {
      text-align: center;
    }

    .filter {
      text-align: center;
      margin-bottom: 10px;
    }

    .map-container {
      position: relative;
      width: 100%;
      max-width: 873px;
      aspect-ratio: 873 / 600;
      background-image: url('https://github.com/safetyhealthenvgs-code/Firemap-Office-First-Floor/blob/main/Lay%20out%20Office%20fist%20Floor.jpg?raw=true');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: top left;
      border: 1px solid #ccc;
      margin: auto;
    }

    .map-container::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0,0,0,0.05) 1px, transparent 1px);
      background-size: 10% 10%;
      pointer-events: none;
    }

    .marker {
      position: absolute;
      width: 12px;
      height: 12px;
      background-color: red;
      border: 2px solid white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
      box-shadow: 0 0 3px rgba(0,0,0,0.5);
    }

    .marker:hover::after {
      content: attr(data-info);
      position: absolute;
      top: -60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: normal;
      z-index: 10;
      min-width: 160px;
      text-align: left;
    }
  </style>
</head>

<body>

<h2>‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡∏ñ‡∏±‡∏á‡∏î‡∏±‡∏ö‡πÄ‡∏û‡∏•‡∏¥‡∏á</h2>

<div class="filter">
  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: </label>
  <select id="monthFilter"></select>
</div>

<div class="map-container" id="map"></div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID = "18YbWGcRIHhxv40v_7NTXQUNL3mV9jnNQrjfcUOvQEQs";
const SHEET_NAME = "Zone Office First Floor";

/* üî¥ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏õ‡∏£‡∏±‡∏ö index ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Google Sheet ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
const DATE_COL = 1;        // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à
const INSPECTOR_COL = 2;   // ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à
const NUMBER_COL = 3;      // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ñ‡∏±‡∏á
const XY_COL = 13;         // ‡∏û‡∏¥‡∏Å‡∏±‡∏î X,Y

const TH_MONTHS = [
  "‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.",
  "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.",
  "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."
];
/* ========================================= */

const jsonUrl =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

let allRows = [];

/* ---------- ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---------- */
fetch(jsonUrl)
  .then(res => res.text())
  .then(text => {
    const json = JSON.parse(text.substring(47).slice(0, -2));
    allRows = json.table.rows;
    buildMonthSelector();
  })
  .catch(err => console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err));

/* ---------- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô parse ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ñ‡∏∂‡∏Å‡∏™‡∏∏‡∏î) ---------- */
function parseSheetDate(cell) {
  if (!cell || !cell.v) return null;

  if (cell.v instanceof Date) {
    return cell.v;
  }

  if (typeof cell.v === "string") {
    const parts = cell.v.split("/");
    if (parts.length === 3) {
      let d = parseInt(parts[0], 10);
      let m = parseInt(parts[1], 10) - 1;
      let y = parseInt(parts[2], 10);
      if (y > 2400) y -= 543; // ‡∏û.‡∏®. ‚Üí ‡∏Ñ.‡∏®.
      const date = new Date(y, m, d);
      if (!isNaN(date)) return date;
    }
  }

  return null;
}

/* ---------- ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ---------- */
function buildMonthSelector() {
  const monthMap = new Map();

  allRows.forEach(row => {
    const d = parseSheetDate(row.c[DATE_COL]);
    if (!d) return;

    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
    const label = `${TH_MONTHS[d.getMonth()]} ${d.getFullYear() + 543}`;
    monthMap.set(key, label);
  });

  const select = document.getElementById("monthFilter");
  select.innerHTML = "";

  if (monthMap.size === 0) {
    const opt = document.createElement("option");
    opt.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô";
    select.appendChild(opt);
    console.warn("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Google Sheet");
    return;
  }

  [...monthMap.entries()]
    .sort((a, b) => b[0].localeCompare(a[0]))
    .forEach(([key, label]) => {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = label;
      select.appendChild(opt);
    });

  renderMap(select.value);
  select.addEventListener("change", () => renderMap(select.value));
}

/* ---------- ‡πÅ‡∏™‡∏î‡∏á Marker ---------- */
function renderMap(selectedMonth) {
  const map = document.getElementById("map");
  map.innerHTML = "";

  allRows.forEach(row => {
    const d = parseSheetDate(row.c[DATE_COL]);
    if (!d) return;

    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
    if (key !== selectedMonth) return;

    const xyStr = row.c[XY_COL]?.v || "";
    if (!xyStr.includes(",")) return;

    const [xStr, yStr] = xyStr.split(",");
    const x = parseFloat(xStr);
    const y = parseFloat(yStr);
    if (isNaN(x) || isNaN(y) || x < 0 || x > 100 || y < 0 || y > 100) return;

    const info = `
      ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à: ${d.toLocaleDateString("th-TH")}<br>
      ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ñ‡∏±‡∏á: ${row.c[NUMBER_COL]?.v || ""}<br>
      ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à: ${row.c[INSPECTOR_COL]?.v || ""}
    `;

    const marker = document.createElement("div");
    marker.className = "marker";
    marker.style.left = `${x}%`;
    marker.style.top = `${y}%`;
    marker.setAttribute("data-info", info);

    map.appendChild(marker);
  });
}
</script>

</body>
</html>


